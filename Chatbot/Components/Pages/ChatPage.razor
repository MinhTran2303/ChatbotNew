@page "/"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http

<link rel="stylesheet" href="css/chat-dark.css" />

<div class="chat-wrapper">
    <div class="chat-header">
        <img src="favicon.png" alt="bot" class="bot-avatar" />
        <div class="bot-info">
            <h3>Smart-Factory Assistant</h3>
            <div class="status"><span class="dot"></span> Đang hoạt động</div>
        </div>
        <button class="close-btn">×</button>
    </div>

 
    <div class="chat-body" @ref="chatBoxRef">
        @foreach (var msg in Messages)
        {
            <div class="@(msg.IsUser ? "user-msg" : "bot-msg")">
                <div class="msg-text">@msg.Text</div>
            </div>
        }
    </div>

    <div class="chat-input">
        <input @bind="UserInput"
               placeholder="Nhập câu hỏi..."
               @onkeydown="HandleEnter" />

        <button class="send-btn" @onclick="SendMessage">
            <span class="send-icon">➤</span>
        </button>
    </div>
</div>

@code {
    private string UserInput = string.Empty;
    private List<ChatMessage> Messages = new();
    private ElementReference chatBoxRef;

    private class ChatMessage
    {
        public bool IsUser { get; set; }
        public string Text { get; set; } = "";
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(UserInput))
            return;

        var messageToSend = UserInput.Trim();
        Messages.Add(new ChatMessage { IsUser = true, Text = messageToSend });
        UserInput = string.Empty;

        Messages.Add(new ChatMessage { IsUser = false, Text = "Đang xử lý..." });
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("/api/aichat/chat", new { message = messageToSend });
            var json = await response.Content.ReadFromJsonAsync<JsonElement>();

            Messages.RemoveAt(Messages.Count - 1);

            if (json.TryGetProperty("reply", out var reply))
                Messages.Add(new ChatMessage { IsUser = false, Text = reply.GetString() ?? "(Không có phản hồi)" });
            else
                Messages.Add(new ChatMessage { IsUser = false, Text = "(Lỗi phản hồi không hợp lệ)" });
        }
        catch (Exception ex)
        {
            Messages.Add(new ChatMessage { IsUser = false, Text = $"❌ Lỗi: {ex.Message}" });
        }

        await ScrollToBottom();
    }

    private async Task HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await SendMessage();
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(100);
        await chatBoxRef.FocusAsync();
    }

    private async Task QuickAsk(string text)
    {
        UserInput = text;
        await SendMessage();
    }
}
